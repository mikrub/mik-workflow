#!/bin/bash
# close-session - Merge and cleanup a ccswitch session
#
# Usage: close-session <session-name>
#
# This:
# 1. Goes to main repo
# 2. Merges feature/<session-name> into main
# 3. Pushes to remote
# 4. Cleans up the ccswitch worktree
#
# Requires: MAIN_REPO environment variable (path to main content repo)

set -e

# Auto-source .env from script directory or fallback
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
if [ -f "$SCRIPT_DIR/.env" ]; then
  source "$SCRIPT_DIR/.env"
elif [ -f "$HOME/.mik-workflow.env" ]; then
  source "$HOME/.mik-workflow.env"
fi

SESSION_NAME="$1"
if [ -z "$SESSION_NAME" ]; then
  echo "Usage: close-session <session-name>"
  echo ""
  echo "Active sessions:"
  # ccswitch stores worktrees in ~/.ccswitch/worktrees/<repo-name>/
  if [ -d "$HOME/.ccswitch/worktrees" ]; then
    find "$HOME/.ccswitch/worktrees" -mindepth 2 -maxdepth 2 -type d 2>/dev/null | while read -r path; do
      repo=$(basename "$(dirname "$path")")
      session=$(basename "$path")
      echo "  $session ($repo)"
    done
  else
    # Fallback to old flat structure
    ls -1 "$HOME/.ccswitch/" 2>/dev/null | grep -v "^\." || echo "  (none)"
  fi
  exit 1
fi

# Require MAIN_REPO env var
MAIN_REPO="${MAIN_REPO:?MAIN_REPO environment variable required (path to main content repo)}"
BRANCH_NAME="feature/$SESSION_NAME"

echo "Closing session: $SESSION_NAME"
echo ""

# Check if branch exists
if ! git -C "$MAIN_REPO" show-ref --verify --quiet "refs/heads/$BRANCH_NAME"; then
  echo "Error: Branch $BRANCH_NAME does not exist"
  exit 1
fi

# Go to main repo and merge
echo "1. Merging $BRANCH_NAME into main..."
cd "$MAIN_REPO"
git checkout main
git merge "$BRANCH_NAME" --no-edit

echo ""
echo "2. Pushing to remote..."
git push

# Merge state repo branch (for HANDOVER.md, project-log.md)
if [ -n "$STATE_REPO" ] && [ -d "$STATE_REPO/.git" ]; then
  if git -C "$STATE_REPO" show-ref --verify --quiet "refs/heads/session-$SESSION_NAME"; then
    echo ""
    echo "3. Merging state branch..."
    git -C "$STATE_REPO" checkout main
    git -C "$STATE_REPO" merge "session-$SESSION_NAME" --no-edit
    git -C "$STATE_REPO" branch -d "session-$SESSION_NAME"
    git -C "$STATE_REPO" push
    echo "State branch merged and pushed"
  fi
fi

echo ""
echo "4. Cleaning up worktree..."
echo "y" | command ccswitch cleanup "$SESSION_NAME" 2>&1

echo ""
echo "Session $SESSION_NAME closed successfully."
