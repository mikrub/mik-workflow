#!/bin/bash
# start-session - Start a new Claude Code session in a ccswitch worktree
#
# Usage: start-session [session-name]
# If no name provided, prompts for one.
#
# This creates a worktree, opens a subshell there, and starts claude.
# When you exit claude, you're back in your original directory.

set -e

# Get session name
SESSION_NAME="$1"
if [ -z "$SESSION_NAME" ]; then
  read -p "Session name: " SESSION_NAME
fi

if [ -z "$SESSION_NAME" ]; then
  echo "Error: Session name required"
  exit 1
fi

# Create worktree via ccswitch and capture output
CCSWITCH_OUTPUT=$(echo "$SESSION_NAME" | command ccswitch create 2>&1)

# Show filtered output to user
echo "$CCSWITCH_OUTPUT" | grep -v -E "^cd |Shell integration|shell-init|source ~/|^$|^To enable|^Then reload"

# Extract worktree path from ccswitch output (looks for "Location: ~/.ccswitch/...")
WORKTREE_PATH=$(echo "$CCSWITCH_OUTPUT" | grep "^Location:" | sed 's/^Location: //' | sed "s|^~|$HOME|")

# Fallback: try the old flat structure if parsing failed
if [ -z "$WORKTREE_PATH" ]; then
  WORKTREE_PATH="$HOME/.ccswitch/$SESSION_NAME"
fi

if [ ! -d "$WORKTREE_PATH" ]; then
  echo "Error: Worktree not created at $WORKTREE_PATH"
  exit 1
fi

# Copy .env from main worktree if it exists
MAIN_WORKTREE=$(cd "$WORKTREE_PATH" && git worktree list --porcelain | grep "^worktree " | head -1 | sed 's/^worktree //')
if [ -f "$MAIN_WORKTREE/.env" ]; then
  cp "$MAIN_WORKTREE/.env" "$WORKTREE_PATH/.env"
  echo "Copied .env from main worktree"
  # Source .env to get STATE_REPO
  source "$WORKTREE_PATH/.env"
fi

# Create session branch in state repo (for HANDOVER.md merge protection)
if [ -n "$STATE_REPO" ] && [ -d "$STATE_REPO/.git" ]; then
  git -C "$STATE_REPO" checkout main 2>/dev/null
  git -C "$STATE_REPO" checkout -b "session-$SESSION_NAME" 2>/dev/null
  echo "Created state branch: session-$SESSION_NAME"
fi

echo ""
echo "Starting Claude Code in worktree...
echo "When you exit claude, run: close-session $SESSION_NAME"
echo ""

# Start subshell in worktree, run claude
(cd "$WORKTREE_PATH" && claude)

echo ""
echo "Session ended. To merge and cleanup, run:"
echo "  close-session $SESSION_NAME"
