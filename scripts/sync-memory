#!/bin/bash
#
# sync-memory: Sync local Basic-Memory corpus to cloud
#
# Run daily (or when needed) to push local changes to cloud.
# Required for claude.ai/mobile access to corpus.
#
# Usage:
#   sync-memory           # Bidirectional sync
#   sync-memory --resync  # First run or reset baseline
#   sync-memory --check   # Verify sync status without transferring
#
# Requires: Basic-Memory cloud account (basicmemory.com)
#

set -euo pipefail

BM="uvx basic-memory"
LOGGED_IN=false

cleanup() {
    if $LOGGED_IN; then
        $BM cloud logout >/dev/null 2>&1 || true
    fi
}
trap cleanup EXIT

PROJECT="mikrub-corpus"
BISYNC_STATE="$HOME/.basic-memory/bisync-state/$PROJECT"

if [[ "${1:-}" == "--check" ]]; then
    echo "Checking sync status..."
    $BM cloud login
    LOGGED_IN=true
    $BM project check --name "$PROJECT"
    exit 0
fi

echo "Syncing to Basic-Memory cloud..."
$BM cloud login
LOGGED_IN=true

# First run needs --resync to establish baseline
if [[ "${1:-}" == "--resync" ]] || [[ ! -d "$BISYNC_STATE" ]]; then
    echo "Establishing sync baseline (first run or resync requested)..."
    $BM project bisync --name "$PROJECT" --resync
else
    $BM project bisync --name "$PROJECT"
fi
echo "Done."
